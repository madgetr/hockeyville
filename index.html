<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trout Creek Rally Stats</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body {
      background-color: #036;
      display: block;
      flex-direction: column;
      align-items: center;
    }

    label {
      color: #fff;
    }

    h1 {
      font-family: "Roboto", serif;
      font-optical-sizing: auto;
      font-style: normal;
      font-variation-settings:
          "wdth" 100;
      font-weight: 900;
      color: #fff;
      text-align: center;
      text-transform: uppercase;
      font-size: 4.25rem;
      line-height: .95;
      margin-bottom: 1rem;
      margin-block-start: 0.83em;
      margin-block-end: 0.83em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      text-shadow: 0 4px rgba(0, 0, 0, .75);
    }

    .shield-image {
      display: block;
      margin-left: auto;
      margin-right: auto;
      width: 50%;
      max-width: 391px;
      filter: drop-shadow(0 2rem 1.5rem rgba(0, 0, 0, .4));
    }

    .table th {
      cursor: pointer;
    }
    .bdr {
      border-radius: 10px;
      overflow: hidden;
    }

  </style>
</head>

<body class="container py-4">
<!--add link to image-->
<a href="https://hockeyville.kraftheinz.com/community/11efd43abbf93d801185f98b382e2880" target="_blank"><img
        src="assets/shield.807ec91d.png" alt="Shield" class="shield-image"></a>
<h1>Trout Creek Rally Stats</h1>
<!--diusplay last modified data on the top right of the table-->
<!-- google map-->
<div class = "bdr" id="map" style="height: 400px; margin-bottom: 20px"></div>
<div class="mb-3 text-center">
  <select id="csv-select" class="form-select mx-auto btn btn-primary dropdown-toggle" style="width: 50%">
    <option class="btn btn-light" value="data/authors.csv">Individual Contributions</option>
    <option class="btn btn-light" value="data/qualified.csv">Qualified For Giveaways</option>
  </select>
</div>
<div class="table-responsive">
  <label for="csv-table" id="last-modified-label">Last Modified: </label>
  <table id="csv-table" class="table table-bordered table-responsive table-hover bdr">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBadYwsOYuVLlK-v9MKIPbK4cEPUxQI-zo&callback=initMap" async defer></script>
<script>
  function initMap() {
    const map = new google.maps.Map(document.getElementById('map'), {
      zoom: 3,
      center: { lat: 46.8283, lng: -79.5795 }
    });
      fetch("data/kraft_facilities.csv")
          .then(response => response.text())
          .then(csvText => {
            const parsedData = Papa.parse(csvText, { header: true });

            parsedData.data.forEach(row => {
              if (row["Pos"] > 10) return;
              const lat = parseFloat(row[" Lat"]);
              const lng = parseFloat(row[" Lng"]);
              const infowindow = new google.maps.InfoWindow({
                content: `<h3>${row[" Facility Name"]}</h3><p>${row[" Points"]}</p>`,
                ariaLabel: `${row[" Facility Name"]}`
              });
              let marker;
              if (!isNaN(lat) && !isNaN(lng)) {
                marker = new google.maps.Marker({
                  position: {lat, lng},
                  label: row["Pos"].toString(),
                  map
                });
                marker.addListener("click", () => {
                  infowindow.open({
                    anchor: marker,
                    map,
                  });
                });
              }
            });
          })
          .catch(error => console.error('Error loading CSV:', error));
  }
  const hiddenFields = ["Facility ID", "isTop4Facility", "ID", "Lat", "Lng"];
  const hiddenOptions = [
    ["data/kraft_facilities.csv", "Standings"],
    ["data/kraft.csv", "Arena Breakdown"],
    ["data/kraft_by_date.csv", "Entries Breakdown"]
  ];
  window.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const fileParam = urlParams.get('file');
    const all = urlParams.get('all');
    if (all) {
      // add standings and arena breakdown to the dropdown
      hiddenOptions.forEach(option => {
        const select = document.getElementById('csv-select');
        const optionElement = document.createElement('option');
        optionElement.value = option[0];
        optionElement.textContent = option[1];
        optionElement.className = 'btn btn-light';
        select.appendChild(optionElement);
      });
    }
    if (fileParam) {
      document.getElementById('csv-select').value = fileParam;
      if (all || !hiddenOptions.some(option => option[0] === fileParam)) {
        loadCSV(fileParam);
      }
    }
  });

  document.getElementById('csv-select').addEventListener('change', function() {
    const file = this.value;
    const url = new URL(window.location);

    if (file) {
      url.searchParams.set('file', file);
      loadCSV(file);
    }
    else {
      url.searchParams.delete('file');
      clearTable();
    }

    window.history.pushState({}, '', url);
  });

  function loadCSV(file) {
    getLastModified();
    fetch(file)
        .then(response => response.text())
        .then(csvText => {
          const parsedData = Papa.parse(csvText, {header: true});
          displayTable(parsedData.data);
        })
        .catch(error => console.error('Error loading CSV:', error));
  }

  function displayTable(data) {
    const tableHead = document.querySelector('#csv-table thead');
    const tableBody = document.querySelector('#csv-table tbody');

    tableHead.innerHTML = '';
    tableBody.innerHTML = '';

    if (data.length === 0) return;

    const headers = Object.keys(data[0]).filter(header => !hiddenFields.includes(header.trim()));
    const headerRow = document.createElement('tr');

    headers.forEach(header => {
      const th = document.createElement('th');
      th.textContent = header;
      headerRow.appendChild(th);
    });
    tableHead.appendChild(headerRow);

    populateTableBody(data, headers);
  }

  function populateTableBody(data, headers) {
    const tableBody = document.querySelector('#csv-table tbody');
    tableBody.innerHTML = '';

    data.forEach(row => {
      const tr = document.createElement('tr');
      headers.forEach(header => {
        const td = document.createElement('td');
        td.textContent = row[header] || '';
        tr.appendChild(td);
      });
      tableBody.appendChild(tr);
    });
  }

  function getLastModified() {
    fetch('data/last_modified.txt')
        .then(response => response.text())
        .then(lastModified => {
          const lastModifiedLabel = document.getElementById('last-modified-label');
          lastModifiedLabel.textContent = `Last Modified: ${lastModified}`;
          console.log(lastModified);
        })
  }

  function sortTable(data, column) {
    const thElements = document.querySelectorAll('th');
    let currentSort = 'asc';

    thElements.forEach(th => {
      if (th.textContent === column) {
        if (th.classList.contains('sort-asc')) {
          currentSort = 'desc';
          th.classList.remove('sort-asc');
          th.classList.add('sort-desc');
        }
        else {
          currentSort = 'asc';
          th.classList.remove('sort-desc');
          th.classList.add('sort-asc');
        }
      }
      else {
        th.classList.remove('sort-asc', 'sort-desc');
      }
    });

    data.sort((a, b) => {
      const valA = isNaN(a[column]) ? a[column] : parseFloat(a[column]);
      const valB = isNaN(b[column]) ? b[column] : parseFloat(b[column]);
      return currentSort === 'asc' ? valA - valB : valB - valA;
    });

    populateTableBody(data, Object.keys(data[0]).filter(header => !hiddenFields.includes(header)));
  }

  function clearTable() {
    document.querySelector('#csv-table thead').innerHTML = '';
    document.querySelector('#csv-table tbody').innerHTML = '';
  }
</script>
</body>
</html>
