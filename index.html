<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trout Creek Rally Stats</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #036;
      display: block;
      flex-direction: column;
      align-items: center;
    }

    label {
      color: #fff;
    }

    h1 {
      font-family: Redzone Bold Reg, Helvetica, Arial, sans-serif;
      font-weight: 400;
      color: #fff;
      text-align: center;
      text-shadow: rgba(0, 0, 0, 0.33) 0px 0px 17.68px, rgba(0, 0, 0, 0.25) 0px 0px 8.84px;
      text-transform: uppercase;
      font-size: 4.25rem;
      line-height: .95;
      margin-bottom: 1rem;
    }

    .shield-image {
      display: block;
      margin: 0 auto;
      scale: 75%;
    }

    .table th {
      cursor: pointer;
    }

    #chart-container {
      display: none;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }
  </style>
</head>
<body class="container py-4">
<img src="assets/shield.807ec91d.png" alt="Shield" class="shield-image">
<h1>Trout Creek Rally Stats</h1>

<div class="mb-3 text-center">
  <select id="csv-select" class="form-select w-auto mx-auto btn btn-primary dropdown-toggle">
    <option class="btn btn-light" value="data/authors.csv">Individual Contributions</option>
    <option class="btn btn-light" value="data/qualified.csv">Qualified For Giveaways</option>
    <option class="btn btn-light" value="data/kraft_by_date.csv">Entries Breakdown</option>
  </select>
</div>

<div class="table-responsive">
  <label for="csv-table" id="last-modified-label">Last Modified: </label>
  <table id="csv-table" class="table table-small table-bordered table-hover">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

<div id="chart-container" class="my-4">
  <canvas id="entriesChart"></canvas>
</div>

<script>
  const hiddenFields = ["Facility ID", "isTop4Facility", "ID"];

  document.getElementById('csv-select').addEventListener('change', function() {
    const file = this.value;
    const url = new URL(window.location);

    if (file) {
      url.searchParams.set('file', file);
      loadPage(file);
    } else {
      url.searchParams.delete('file');
      clearTable();
    }

    window.history.pushState({}, '', url);
  });

  function loadPage(file) {
    if (file === 'data/kraft_by_date.csv') {
      loadCSV(file, true);
    } else {
      loadCSV(file);
    }
  }

  function loadCSV(file, isChart = false) {
    fetch(file)
        .then(response => response.text())
        .then(csvText => {
          const parsedData = Papa.parse(csvText, { header: true });
          if (isChart) {
            displayChart(parsedData.data);
          } else {
            displayTable(parsedData.data);
          }
        })
        .catch(error => console.error('Error loading CSV:', error));
  }

  function displayTable(data) {
    document.getElementById('chart-container').style.display = 'none';
    const tableHead = document.querySelector('#csv-table thead');
    const tableBody = document.querySelector('#csv-table tbody');
    tableHead.innerHTML = '';
    tableBody.innerHTML = '';

    if (data.length === 0) return;

    const headers = Object.keys(data[0]).filter(header => !hiddenFields.includes(header.trim()));
    const headerRow = document.createElement('tr');

    headers.forEach(header => {
      const th = document.createElement('th');
      th.textContent = header;
      headerRow.appendChild(th);
    });
    tableHead.appendChild(headerRow);

    data.forEach(row => {
      const tr = document.createElement('tr');
      headers.forEach(header => {
        const td = document.createElement('td');
        td.textContent = row[header] || '';
        tr.appendChild(td);
      });
      tableBody.appendChild(tr);
    });
  }

  function displayChart(data) {
    document.getElementById('chart-container').style.display = 'block';
    document.querySelector('#csv-table thead').innerHTML = '';
    document.querySelector('#csv-table tbody').innerHTML = '';

    const dates = data.map(row => row.Date).filter(Boolean);
    const entries = data.map(row => parseInt(row.Entries)).filter(num => !isNaN(num));

    const ctx = document.getElementById('entriesChart').getContext('2d');
    if (window.entriesChart) {
      window.entriesChart.destroy();
    }

    window.entriesChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: dates,
        datasets: [{
          label: 'Entries Over Time',
          data: entries,
          borderColor: '#007bff',
          backgroundColor: 'rgba(0, 123, 255, 0.1)',
          tension: 0.3,
          pointRadius: 4,
          pointHoverRadius: 6,
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'Date' } },
          y: { title: { display: true, text: 'Entries' }, beginAtZero: true }
        }
      }
    });
  }

  function clearTable() {
    document.querySelector('#csv-table thead').innerHTML = '';
    document.querySelector('#csv-table tbody').innerHTML = '';
    document.getElementById('chart-container').style.display = 'none';
  }
</script>
</body>
</html>
